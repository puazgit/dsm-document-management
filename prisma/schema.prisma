generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                 String             @id @default(cuid())
  username           String             @unique @db.VarChar(50)
  email              String             @unique @db.VarChar(255)
  passwordHash       String             @map("password_hash") @db.VarChar(255)
  firstName          String             @map("first_name") @db.VarChar(100)
  lastName           String             @map("last_name") @db.VarChar(100)
  isActive           Boolean            @default(true) @map("is_active")
  createdAt          DateTime           @default(now()) @map("created_at")
  updatedAt          DateTime           @updatedAt @map("updated_at")
  groupId            String?            @map("group_id")
  divisiId           String?            @map("divisi_id")
  department         String?            @db.VarChar(100)
  emailVerifiedAt    DateTime?          @map("email_verified_at")
  lastLoginAt        DateTime?          @map("last_login_at")
  phone              String?            @db.VarChar(20)
  position           String?            @db.VarChar(100)
  auditLogs          AuditLog[]
  comments           Comment[]
  headOfDivisions    Divisi[]           @relation("DivisiHead")
  documentActivities DocumentActivity[]
  documentHistory    DocumentHistory[]  @relation("DocumentHistoryChangedBy")
  documentVersions   DocumentVersion[]
  approvedDocuments  Document[]         @relation("DocumentApprovedBy")
  createdDocuments   Document[]         @relation("DocumentCreatedBy")
  updatedDocuments   Document[]         @relation("DocumentUpdatedBy")
  notifications      Notification[]
  assignedPpds       Ppd[]              @relation("PpdAssignedBy")
  ppdAssignments     Ppd[]              @relation("PpdUser")
  sessions           Session[]
  systemLogs         SystemLog[]
  assignedUserRoles  UserRole[]         @relation("UserRoleAssignedBy")
  userRoles          UserRole[]
  divisi             Divisi?            @relation(fields: [divisiId], references: [id])
  group              Group?             @relation(fields: [groupId], references: [id])

  @@index([groupId])
  @@index([divisiId])
  @@index([isActive])
  @@index([email])
  @@index([username])
  @@map("users")
}

model Group {
  id          String   @id @default(cuid())
  name        String   @unique @db.VarChar(100)
  displayName String   @map("display_name") @db.VarChar(255)
  description String?
  createdAt   DateTime @default(now()) @map("created_at")
  isActive    Boolean  @default(true) @map("is_active")
  users       User[]
  menuItems   Menu[]   @relation("GroupToMenu")

  @@index([isActive])
  @@map("groups")
}

model Role {
  id                    String                     @id @default(cuid())
  name                  String                     @unique @db.VarChar(100)
  displayName           String                     @map("display_name") @db.VarChar(255)
  description           String?
  level                 Int                        @default(0)
  isActive              Boolean                    @default(true) @map("is_active")
  isSystem              Boolean                    @default(false) @map("is_system")
  createdAt             DateTime                   @default(now()) @map("created_at")
  updatedAt             DateTime                   @updatedAt @map("updated_at")
  rolePermissions       RolePermission[]
  userRoles             UserRole[]
  capabilityAssignments RoleCapabilityAssignment[]

  @@map("roles")
}

model Permission {
  id              String           @id @default(cuid())
  name            String           @unique @db.VarChar(100)
  displayName     String           @map("display_name") @db.VarChar(255)
  description     String?
  module          String           @db.VarChar(100)
  action          String           @db.VarChar(100)
  resource        String?          @db.VarChar(100)
  isActive        Boolean          @default(true) @map("is_active")
  createdAt       DateTime         @default(now()) @map("created_at")
  rolePermissions RolePermission[]

  @@unique([module, action, resource])
  @@map("permissions")
}

model UserRole {
  id             String    @id @default(cuid())
  userId         String    @map("user_id")
  roleId         String    @map("role_id")
  assignedBy     String    @map("assigned_by")
  assignedAt     DateTime  @default(now()) @map("assigned_at")
  expiresAt      DateTime? @map("expires_at")
  isActive       Boolean   @default(true) @map("is_active")
  assignedByUser User      @relation("UserRoleAssignedBy", fields: [assignedBy], references: [id])
  role           Role      @relation(fields: [roleId], references: [id], onDelete: Cascade)
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId])
  @@index([userId])
  @@index([roleId])
  @@index([isActive])
  @@index([userId, isActive])
  @@index([assignedBy])
  @@map("user_roles")
}

model RolePermission {
  id           String     @id @default(cuid())
  roleId       String     @map("role_id")
  permissionId String     @map("permission_id")
  isGranted    Boolean    @default(true) @map("is_granted")
  source       String     @default("manual") @db.VarChar(50)
  createdAt    DateTime   @default(now()) @map("created_at")
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@map("role_permissions")
}

// Role Capabilities - High-level capabilities that roles can have
// Eliminates hardcoded role name checks throughout the codebase
model RoleCapability {
  id          String                     @id @default(cuid())
  name        String                     @unique @db.VarChar(100) // e.g., 'ADMIN_ACCESS', 'DOCUMENT_FULL_ACCESS'
  description String?
  category    String?                    @db.VarChar(50) // 'system', 'document', 'user', etc.
  createdAt   DateTime                   @default(now()) @map("created_at")
  updatedAt   DateTime                   @updatedAt @map("updated_at")
  assignments RoleCapabilityAssignment[]

  @@index([category])
  @@map("role_capabilities")
}

model RoleCapabilityAssignment {
  roleId       String         @map("role_id")
  capabilityId String         @map("capability_id")
  assignedAt   DateTime       @default(now()) @map("assigned_at")
  capability   RoleCapability @relation(fields: [capabilityId], references: [id], onDelete: Cascade)
  role         Role           @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@id([roleId, capabilityId])
  @@index([roleId])
  @@index([capabilityId])
  @@map("role_capability_assignments")
}

// Resources - Unified Access Control for Navigation, Routes, and APIs
// Database-driven access control system
model Resource {
  id                 String     @id @db.VarChar(50)
  type               String     @db.VarChar(20) // 'navigation', 'route', 'api'
  path               String     @db.VarChar(255)
  name               String     @db.VarChar(100)
  description        String?
  parentId           String?    @map("parent_id") @db.VarChar(50)
  requiredCapability String?    @map("required_capability") @db.VarChar(100)
  icon               String?    @db.VarChar(50)
  sortOrder          Int        @default(0) @map("sort_order")
  isActive           Boolean    @default(true) @map("is_active")
  metadata           Json?
  createdAt          DateTime   @default(now()) @map("created_at")
  updatedAt          DateTime   @updatedAt @map("updated_at")
  
  parent             Resource?  @relation("ResourceParent", fields: [parentId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  children           Resource[] @relation("ResourceParent")

  @@index([type])
  @@index([path])
  @@index([parentId])
  @@index([requiredCapability])
  @@index([type, isActive])
  @@index([type, path])
  @@map("resources")
}

// Workflow Transitions - Database-driven document workflow
// Replaces hardcoded minLevel and status transition rules
model WorkflowTransition {
  id                 String   @id @default(cuid())
  fromStatus         String   @map("from_status") @db.VarChar(50)
  toStatus           String   @map("to_status") @db.VarChar(50)
  minLevel           Int      @map("min_level") // Minimum role level required
  requiredPermission String?  @map("required_permission") @db.VarChar(100)
  description        String?
  allowedByLabel     String?  @map("allowed_by_label") @db.VarChar(200) // Display: "Editor, Manager"
  isActive           Boolean  @default(true) @map("is_active")
  sortOrder          Int      @default(0) @map("sort_order")
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  @@unique([fromStatus, toStatus])
  @@index([fromStatus])
  @@index([toStatus])
  @@index([isActive])
  @@index([fromStatus, isActive])
  @@map("workflow_transitions")
}

model Divisi {
  id          String   @id @default(cuid())
  name        String   @db.VarChar(200)
  code        String   @unique @db.VarChar(50)
  description String?
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  parentId    String?  @map("parent_id")
  headId      String?  @map("head_id")
  head        User?    @relation("DivisiHead", fields: [headId], references: [id])
  parent      Divisi?  @relation("DivisiParent", fields: [parentId], references: [id])
  children    Divisi[] @relation("DivisiParent")
  ppds        Ppd[]
  users       User[]

  @@map("divisi")
}

model Ppd {
  id              String   @id @default(cuid())
  userId          String   @map("user_id")
  divisiId        String   @map("divisi_id")
  documentTypeIds String[] @map("document_type_ids")
  isActive        Boolean  @default(true) @map("is_active")
  assignedAt      DateTime @default(now()) @map("assigned_at")
  assignedById    String   @map("assigned_by_id")
  assignedBy      User     @relation("PpdAssignedBy", fields: [assignedById], references: [id])
  divisi          Divisi   @relation(fields: [divisiId], references: [id])
  user            User     @relation("PpdUser", fields: [userId], references: [id])

  @@unique([userId, divisiId])
  @@map("ppd")
}

model DocumentType {
  id               String     @id @default(cuid())
  name             String     @db.VarChar(200)
  slug             String     @unique @db.VarChar(200)
  description      String?
  icon             String?    @db.VarChar(100)
  color            String?    @db.VarChar(50)
  accessLevel      Int        @default(1) @map("access_level")
  requiredApproval Boolean    @default(false) @map("required_approval")
  retentionPeriod  Int?       @map("retention_period")
  isActive         Boolean    @default(true) @map("is_active")
  sortOrder        Int        @default(0) @map("sort_order")
  createdAt        DateTime   @default(now()) @map("created_at")
  documents        Document[]

  @@map("documents_type")
}

model Document {
  id               String             @id @default(cuid())
  title            String             @db.VarChar(500)
  description      String?
  fileName         String             @map("file_name") @db.VarChar(500)
  filePath         String             @map("file_path")
  fileSize         BigInt?            @map("file_size")
  fileType         String?            @map("file_type") @db.VarChar(100)
  mimeType         String?            @map("mime_type") @db.VarChar(100)
  version          String             @default("1.0") @db.VarChar(50)
  status           DocumentStatus     @default(DRAFT)
  accessGroups     String[]           @map("access_groups")
  downloadCount    Int                @default(0) @map("download_count")
  viewCount        Int                @default(0) @map("view_count")
  tags             String[]
  metadata         Json?
  publishedAt      DateTime?          @map("published_at")
  expiresAt        DateTime?          @map("expires_at")
  createdAt        DateTime           @default(now()) @map("created_at")
  updatedAt        DateTime           @updatedAt @map("updated_at")
  // Full-text search fields
  extractedText    String?            @map("extracted_text") @db.Text
  extractedAt      DateTime?          @map("extracted_at")
  extractionStatus String?            @default("pending") @map("extraction_status") @db.VarChar(20)
  documentTypeId   String             @map("document_type_id")
  createdById      String             @map("created_by_id")
  updatedById      String?            @map("updated_by_id")
  approvedById     String?            @map("approved_by_id")
  approvedAt       DateTime?          @map("approved_at")
  comments       Comment[]
  activities     DocumentActivity[]
  history        DocumentHistory[]
  versions       DocumentVersion[]
  approvedBy     User?              @relation("DocumentApprovedBy", fields: [approvedById], references: [id])
  createdBy      User               @relation("DocumentCreatedBy", fields: [createdById], references: [id])
  documentType   DocumentType       @relation(fields: [documentTypeId], references: [id])
  updatedBy      User?              @relation("DocumentUpdatedBy", fields: [updatedById], references: [id])

  @@index([documentTypeId])
  @@index([createdById])
  @@index([updatedById])
  @@index([approvedById])
  @@index([status])
  @@index([createdAt])
  @@index([extractionStatus])
  @@index([createdById, status])
  @@index([documentTypeId, status])
  @@index([status, documentTypeId, createdAt(sort: Desc)])
  @@map("documents")
}

model DocumentHistory {
  id           String          @id @default(cuid())
  documentId   String          @map("document_id")
  action       String          @db.VarChar(50)
  fieldChanged String?         @map("field_changed") @db.VarChar(100)
  oldValue     String?         @map("old_value")
  newValue     String?         @map("new_value")
  statusFrom   DocumentStatus? @map("status_from")
  statusTo     DocumentStatus? @map("status_to")
  changedById  String          @map("changed_by_id")
  changeReason String?         @map("change_reason")
  metadata     Json?
  createdAt    DateTime        @default(now()) @map("created_at")
  changedBy    User            @relation("DocumentHistoryChangedBy", fields: [changedById], references: [id])
  document     Document        @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@index([documentId])
  @@index([createdAt])
  @@index([action])
  @@index([changedById])
  @@index([documentId, createdAt])
  @@map("document_history")
}

model DocumentVersion {
  id              String            @id @default(cuid())
  documentId      String            @map("document_id")
  version         String            @db.VarChar(50)
  changes         String?
  fileName        String            @map("file_name") @db.VarChar(500)
  filePath        String            @map("file_path")
  fileSize        BigInt?           @map("file_size")
  previousVersion String?           @map("previous_version") @db.VarChar(50)
  createdById     String            @map("created_by_id")
  createdAt       DateTime          @default(now()) @map("created_at")
  parentVersionId String?           @map("parent_version_id")
  createdBy       User              @relation(fields: [createdById], references: [id])
  document        Document          @relation(fields: [documentId], references: [id], onDelete: Cascade)
  parentVersion   DocumentVersion?  @relation("VersionHierarchy", fields: [parentVersionId], references: [id])
  childVersions   DocumentVersion[] @relation("VersionHierarchy")

  @@unique([documentId, version])
  @@index([documentId])
  @@index([createdById])
  @@index([createdAt])
  @@index([parentVersionId])
  @@map("document_versions")
}

model Comment {
  id         String    @id @default(cuid())
  documentId String    @map("document_id")
  parentId   String?   @map("parent_id")
  userId     String    @map("user_id")
  content    String
  isEdited   Boolean   @default(false) @map("is_edited")
  editedAt   DateTime? @map("edited_at")
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")
  document   Document  @relation(fields: [documentId], references: [id], onDelete: Cascade)
  parent     Comment?  @relation("CommentReplies", fields: [parentId], references: [id])
  replies    Comment[] @relation("CommentReplies")
  user       User      @relation(fields: [userId], references: [id])

  @@index([documentId])
  @@index([userId])
  @@index([parentId])
  @@index([createdAt])
  @@map("comments")
}

model Notification {
  id        String           @id @default(cuid())
  userId    String           @map("user_id")
  title     String           @db.VarChar(500)
  message   String?
  type      NotificationType @default(DOCUMENT_UPLOADED)
  data      Json?
  isRead    Boolean          @default(false) @map("is_read")
  readAt    DateTime?        @map("read_at")
  expiresAt DateTime?        @map("expires_at")
  createdAt DateTime         @default(now()) @map("created_at")
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notifications")
}

model Menu {
  id           String   @id @default(cuid())
  name         String   @db.VarChar(200)
  url          String?  @db.VarChar(500)
  icon         String?  @db.VarChar(100)
  parentId     String?  @map("parent_id")
  sortOrder    Int      @default(0) @map("sort_order")
  accessGroups String[] @map("access_groups")
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  parent       Menu?    @relation("MenuParent", fields: [parentId], references: [id])
  children     Menu[]   @relation("MenuParent")
  groups       Group[]  @relation("GroupToMenu")

  @@map("menu")
}

model DocumentActivity {
  id          String         @id @default(cuid())
  documentId  String         @map("document_id")
  userId      String         @map("user_id")
  action      ActivityAction
  description String?
  ipAddress   String?        @map("ip_address") @db.Inet
  userAgent   String?        @map("user_agent")
  metadata    Json?
  createdAt   DateTime       @default(now()) @map("created_at")
  document    Document       @relation(fields: [documentId], references: [id], onDelete: Cascade)
  user        User           @relation(fields: [userId], references: [id])

  @@index([documentId])
  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@index([documentId, action])
  @@map("document_activities")
}

model SystemLog {
  id          String         @id @default(cuid())
  userId      String?        @map("user_id")
  action      ActivityAction
  entity      String?        @db.VarChar(100)
  entityId    String?        @map("entity_id")
  description String?
  ipAddress   String?        @map("ip_address") @db.Inet
  userAgent   String?        @map("user_agent")
  metadata    Json?
  createdAt   DateTime       @default(now()) @map("created_at")
  user        User?          @relation(fields: [userId], references: [id])

  @@map("system_logs")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime
  ipAddress    String?  @map("ip_address") @db.Inet
  userAgent    String?  @map("user_agent")
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model SystemConfig {
  id          String   @id @default(cuid())
  key         String   @unique @db.VarChar(200)
  value       String?
  dataType    String   @map("data_type") @db.VarChar(50)
  category    String?  @db.VarChar(100)
  description String?
  isEditable  Boolean  @default(true) @map("is_editable")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("system_config")
}

model AuditLog {
  id         String   @id @default(cuid())
  action     String   @db.VarChar(50)
  resource   String   @db.VarChar(50)
  resourceId String   @map("resource_id") @db.VarChar(255)
  actorId    String   @map("actor_id")
  details    String?
  ipAddress  String?  @map("ip_address") @db.VarChar(45)
  userAgent  String?  @map("user_agent")
  metadata   String?
  createdAt  DateTime @default(now()) @map("created_at")
  actor      User     @relation(fields: [actorId], references: [id], onDelete: Cascade)

  @@index([action])
  @@index([resource])
  @@index([resourceId])
  @@index([actorId])
  @@index([createdAt])
  @@map("audit_logs")
}

enum DocumentStatus {
  DRAFT
  PENDING_REVIEW
  PENDING_APPROVAL
  APPROVED
  PUBLISHED
  REJECTED
  ARCHIVED
  EXPIRED

  @@map("document_status")
}

enum NotificationType {
  DOCUMENT_UPLOADED
  DOCUMENT_APPROVED
  DOCUMENT_REJECTED
  DOCUMENT_PUBLISHED
  COMMENT_ADDED
  COMMENT_REPLIED
  DOCUMENT_EXPIRED
  ACCESS_GRANTED
  SYSTEM_MAINTENANCE
  USER_MENTIONED

  @@map("notification_type")
}

enum ActivityAction {
  CREATE
  UPDATE
  DELETE
  VIEW
  DOWNLOAD
  APPROVE
  REJECT
  PUBLISH
  COMMENT
  LOGIN
  LOGOUT

  @@map("activity_action")
}
